{% extends 'base.html' %}
{% load static %}

{% block title %}Delivery Dashboard - FastDrop{% endblock %}

{% block extra_head %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=geometry"></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Delivery Agent Info -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Delivery Agent Info</h5>
                </div>
                <div class="card-body">
                    <p><strong>Name:</strong> {{ request.user.get_full_name }}</p>
                    <p><strong>Email:</strong> {{ request.user.email }}</p>
                    <p><strong>Current Location:</strong> <span id="current-location">Updating...</span></p>
                </div>
            </div>
        </div>

        <!-- Active Deliveries -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Active Deliveries</h5>
                </div>
                <div class="card-body">
                    {% if active_deliveries %}
                    {% for delivery in active_deliveries %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6>Order #{{ delivery.id }}</h6>
                            <p><strong>Store:</strong> {{ delivery.store.name }}</p>
                            <p><strong>Status:</strong> <span
                                    class="badge {% if delivery.status == 'CONFIRMED' %}bg-info{% elif delivery.status == 'PICKED' %}bg-primary{% endif %}">{{
                                    delivery.status }}</span></p>
                            <p><strong>Delivery Address:</strong> {{ delivery.address }}, {{ delivery.city }}, {{
                                delivery.state }} - {{ delivery.pincode }}</p>

                            {% if delivery.status == 'CONFIRMED' %}
                            <button class="btn btn-primary btn-sm mark-picked" data-order-id="{{ delivery.id }}">Mark as
                                Picked</button>
                            {% elif delivery.status == 'PICKED' %}
                            <button class="btn btn-success btn-sm mark-delivered" data-order-id="{{ delivery.id }}">Mark
                                as Delivered</button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p>No active deliveries.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Map Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Delivery Route</h5>
                </div>
                <div class="card-body">
                    <div id="map" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let map;
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: { lat: 20.5937, lng: 78.9629 } // Default center (India); update dynamically if needed
        });

        {% if polyline %}
        console.log("Polyline received:", "{{ polyline|escapejs }}");

        if (typeof google !== "undefined" && google.maps && google.maps.geometry) {
            const decodedPath = google.maps.geometry.encoding.decodePath("{{ polyline|escapejs }}");
            const bounds = new google.maps.LatLngBounds();

            decodedPath.forEach(point => bounds.extend(point));
            map.fitBounds(bounds);

            const polylinePath = new google.maps.Polyline({
                path: decodedPath,
                geodesic: true,
                strokeColor: "#4285F4",
                strokeOpacity: 1.0,
                strokeWeight: 4
            });
            polylinePath.setMap(map);
        } else {
            console.error("Google Maps Geometry library is not loaded.");
        }
        {% endif %}
    }

    window.onload = function () {
        initMap();
    };
</script>
{% endblock %}