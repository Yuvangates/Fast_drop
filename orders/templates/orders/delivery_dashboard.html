{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<!-- Load Google Maps API with callback -->
<script>
function initGoogleMaps() {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap`;
    script.async = true;
    script.defer = true;
    
    // Add error handling
    script.onerror = function() {
        console.error('Failed to load Google Maps API script');
        showMapError('Failed to load Google Maps API. Please check your internet connection.');
    };
    
    document.head.appendChild(script);
}

// Start loading when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGoogleMaps);
} else {
    initGoogleMaps();
}
</script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    {% if error_message %}
    <div class="alert alert-danger" role="alert">
        {{ error_message }}
    </div>
    {% endif %}

    <div class="row">
        <!-- Map Section -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Delivery Route Map</h5>
                    <div class="btn-group" id="map-type-buttons" style="display: none;">
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleMapType('roadmap')">Road</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleMapType('satellite')">Satellite</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleMapType('terrain')">Terrain</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="map" style="height: 500px; width: 100%; position: relative;">
                        <div id="map-loading" class="text-center p-4" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.9); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 1;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading map...</span>
                            </div>
                            <p class="mt-2 mb-0">Loading map...</p>
                        </div>
                        <div id="map-error" class="alert alert-danger d-none m-3" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1; max-width: 80%;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div class="col-md-4">
            <!-- Assigned Orders -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Your Active Deliveries</h5>
                </div>
                <div class="card-body">
                    {% for order in assigned_orders %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">Order #{{ order.id }}</h6>
                            <p class="card-text">
                                <strong>Store:</strong> {{ order.store.name|default:"Not assigned" }}<br>
                                <strong>Customer:</strong> {{ order.user.get_full_name|default:"Not available" }}<br>
                                <strong>Address:</strong> {{ order.address }}, {{ order.city }}<br>
                                <strong>Status:</strong> 
                                <span class="badge {% if order.status == 'CONFIRMED' %}bg-info{% else %}bg-primary{% endif %}">
                                    {{ order.status }}
                                </span>
                            </p>
                            
                            <!-- Products Section -->
                            <div class="products-section mt-3">
                                <h6 class="mb-2">Products:</h6>
                                {% for order_item in order.items.all %}
                                <div class="product-item d-flex align-items-center mb-2">
                                    {% if order_item.item.image %}
                                        <img src="{{ order_item.item.image.url }}" alt="{{ order_item.item.name }}" class="product-image me-2" style="width: 50px; height: 50px; object-fit: cover;">
                                    {% else %}
                                        <img src="{% static 'images/placeholder.svg' %}" alt="{{ order_item.item.name }}" class="product-image me-2" style="width: 50px; height: 50px; object-fit: cover;">
                                    {% endif %}
                                    <div class="product-info">
                                        <p class="mb-0"><strong>{{ order_item.item.name }}</strong></p>
                                        <p class="mb-0 text-muted">Quantity: {{ order_item.quantity }}</p>
                                        <p class="mb-0 text-muted">₹{{ order_item.price }}</p>
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted">No products in this order.</p>
                                {% endfor %}
                            </div>

                            {% if order.status == 'CONFIRMED' %}
                            <form method="post" action="{% url 'orders:update_delivery_status' order.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="status" value="PICKED">
                                <button type="submit" class="btn btn-primary btn-sm">Mark as Picked</button>
                            </form>
                            {% elif order.status == 'PICKED' %}
                            <form method="post" action="{% url 'orders:update_delivery_status' order.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="status" value="DELIVERED">
                                <button type="submit" class="btn btn-success btn-sm">Mark as Delivered</button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-center">No active deliveries assigned.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Available Orders -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Available Orders</h5>
                </div>
                <div class="card-body">
                    {% for order in pickup_orders %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">Order #{{ order.id }}</h6>
                            <p class="card-text">
                                <strong>Store:</strong> {{ order.store.name }}<br>
                                <strong>Customer:</strong> {{ order.user.get_full_name }}<br>
                                <strong>Address:</strong> {{ order.address }}, {{ order.city }}
                            </p>

                            <!-- Products Section -->
                            <div class="products-section mt-3">
                                <h6 class="mb-2">Products:</h6>
                                {% for order_item in order.items.all %}
                                <div class="product-item d-flex align-items-center mb-2">
                                    {% if order_item.item.image %}
                                        <img src="{{ order_item.item.image.url }}" alt="{{ order_item.item.name }}" class="product-image me-2" style="width: 50px; height: 50px; object-fit: cover;">
                                    {% else %}
                                        <img src="{% static 'images/placeholder.svg' %}" alt="{{ order_item.item.name }}" class="product-image me-2" style="width: 50px; height: 50px; object-fit: cover;">
                                    {% endif %}
                                    <div class="product-info">
                                        <p class="mb-0"><strong>{{ order_item.item.name }}</strong></p>
                                        <p class="mb-0 text-muted">Quantity: {{ order_item.quantity }}</p>
                                        <p class="mb-0 text-muted">₹{{ order_item.price }}</p>
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted">No products in this order.</p>
                                {% endfor %}
                            </div>

                            <form method="post" action="{% url 'orders:accept_delivery' order.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary btn-sm">Accept Delivery</button>
                            </form>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-center">No available orders to pick up.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let map = null;
let directionsService = null;
let directionsRenderer = null;
let markers = [];
let infoWindows = [];

function showMapError(message) {
    const loadingDiv = document.getElementById('map-loading');
    const errorDiv = document.getElementById('map-error');
    const mapTypeButtons = document.getElementById('map-type-buttons');
    
    if (loadingDiv) {
        loadingDiv.style.display = 'none';
    }
    
    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('d-none');
    }

    if (mapTypeButtons) {
        mapTypeButtons.style.display = 'none';
    }
    
    console.error('Map Error:', message);
}

function initMap() {
    try {
        const mapDiv = document.getElementById('map');
        const loadingDiv = document.getElementById('map-loading');
        const mapTypeButtons = document.getElementById('map-type-buttons');

        if (!mapDiv) {
            showMapError('Map container not found.');
            return;
        }

        // Initialize the map
        const defaultCenter = { lat: 22.3149, lng: 87.3105 }; // IIT Kharagpur coordinates
        map = new google.maps.Map(mapDiv, {
            zoom: 14,
            center: defaultCenter,
            mapTypeControl: false, // We'll use our custom buttons
            streetViewControl: true,
            fullscreenControl: true,
            gestureHandling: 'cooperative'
        });

        // Show map type buttons once map is loaded
        if (mapTypeButtons) {
            mapTypeButtons.style.display = 'flex';
        }

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true // We'll add custom markers
        });

        // Add markers and calculate route
        const waypoints = [];
        {% if assigned_orders %}
            {% for order in assigned_orders %}
                {% if order.store and order.store.latitude and order.store.longitude %}
                    const storeLocation_{{ order.id }} = {
                        lat: {{ order.store.latitude }},
                        lng: {{ order.store.longitude }}
                    };
                    
                    addMarker(
                        storeLocation_{{ order.id }},
                        "Store: {{ order.store.name }}",
                        `<div class="p-2">
                            <h6>Store: {{ order.store.name }}</h6>
                            <p class="mb-0">Address: {{ order.store.address }}</p>
                            <p class="mb-0">Contact: {{ order.store.contact_number }}</p>
                        </div>`,
                        'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    );
                    
                    waypoints.push({
                        location: storeLocation_{{ order.id }},
                        stopover: true
                    });
                {% endif %}

                {% if order.latitude and order.longitude %}
                    const deliveryLocation_{{ order.id }} = {
                        lat: {{ order.latitude }},
                        lng: {{ order.longitude }}
                    };
                    
                    addMarker(
                        deliveryLocation_{{ order.id }},
                        "Delivery: Order #{{ order.id }}",
                        `<div class="p-2">
                            <h6>Order #{{ order.id }}</h6>
                            <p class="mb-0">Address: {{ order.address }}, {{ order.city }}</p>
                            <p class="mb-0">Status: {{ order.status }}</p>
                        </div>`,
                        'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                    );
                    
                    waypoints.push({
                        location: deliveryLocation_{{ order.id }},
                        stopover: true
                    });
                {% endif %}
            {% endfor %}

            if (waypoints.length > 0) {
                calculateRoute(waypoints);
            } else {
                showMapError('No valid locations found for route calculation.');
            }
        {% endif %}

        // Hide loading indicator
        if (loadingDiv) {
            loadingDiv.style.display = 'none';
        }

    } catch (error) {
        console.error('Error initializing map:', error);
        showMapError('Failed to initialize map: ' + error.message);
    }
}

function addMarker(position, title, content, icon = null) {
    if (!position || !position.lat || !position.lng) {
        console.warn('Invalid position for marker:', title);
        return null;
    }

    const marker = new google.maps.Marker({
        position: position,
        map: map,
        title: title,
        animation: google.maps.Animation.DROP,
        icon: icon
    });

    const infoWindow = new google.maps.InfoWindow({
        content: content,
        maxWidth: 300
    });

    marker.addListener('click', () => {
        infoWindows.forEach(window => window.close());
        infoWindow.open(map, marker);
    });

    markers.push(marker);
    infoWindows.push(infoWindow);
    return marker;
}

function calculateRoute(waypoints) {
    if (!directionsService || !directionsRenderer || waypoints.length < 2) return;

    const origin = waypoints[0].location;
    const destination = waypoints[waypoints.length - 1].location;
    const intermediateWaypoints = waypoints.slice(1, -1);

    directionsService.route({
        origin: origin,
        destination: destination,
        waypoints: intermediateWaypoints,
        optimizeWaypoints: true,
        travelMode: google.maps.TravelMode.DRIVING
    }, (response, status) => {
        if (status === 'OK') {
            directionsRenderer.setDirections(response);
            const bounds = new google.maps.LatLngBounds();
            response.routes[0].legs.forEach((leg) => {
                bounds.extend(leg.start_location);
                bounds.extend(leg.end_location);
            });
            map.fitBounds(bounds);
        } else {
            console.error('Directions request failed:', status);
            showMapError('Failed to calculate route. Showing markers only.');
            showMarkersOnly();
        }
    });
}

function showMarkersOnly() {
    const bounds = new google.maps.LatLngBounds();
    markers.forEach(marker => {
        bounds.extend(marker.getPosition());
    });

    if (!bounds.isEmpty()) {
        map.fitBounds(bounds);
    } else {
        map.setCenter({ lat: 22.3149, lng: 87.3105 });
        map.setZoom(14);
    }
}

window.toggleMapType = function(type) {
    if (map) {
        map.setMapTypeId(type);
    }
};
</script>
{% endblock %} 